# 第03章、基于 ESP32-C3 智能照明设备的硬件设计 <!-- 开头使用一级标题 -->
<!-- 开头空一行 -->

<!-- 说明文档目的 -->
本文档将介绍基于 ESP32-C3 设计智能照明设备硬件。

## 1. 概述 <!-- 使用二级标题 -->

<!-- 开头空一行 -->
   ESP32-C3 系列芯片是低功耗、高集成度的 MCU 系统级芯片 (SoC)，集成 2.4 GHz Wi-Fi 和低功耗蓝牙 (Bluetooth® LE) 双模无线通信，专为物联网 (IoT)、智能家居、工业自动化、医疗保健及消费电子产品等各种应 用而设计，具有行业领先的低功耗性能和射频性能。
   
   ESP32-C3 系列搭载 RISC-V 32 位单核处理器，工作频率高达 160 MHz。芯片支持二次开发，无需使用其他微控制器或处理器。内置 400 KB SRAM(其中 16 KB 专用于cache)、384 KB ROM 存储空间，CPU 的指令空间、只读数据空间可以映射到外部 flash，外部 flash 可以最大支持 16 MB，并支持SPI，UART，I2S，I2C，红外收发器，USB 串口/JTAG 控制器，DMA控制器，TWAI® 控制器，LED PWM，ADC等接口。
   
   ESP32-C3具有完善的安全机制，支持硬件加密加速器支持 AES-128/256、Hash、 RSA、HMAC、数字签名和安全启动，集成随机数发生器，支持片上存储器、片外存储器和外设的访问权限管理，支持片外存储器加解密功能。
   
<!-- 列表上下空一行 --> 
  在应用于智能照明设备时，ESP32-C3 的 LED PWM 控制器可以生成六路独立的数字 PWM 波形，具有如下特性:

 - 波形的周期和占空比可配置，占空比精确度可达 18 位
 - 多种时钟源选择，包括 APB 总线时钟、外置主晶振时钟
 - 可在 Light-sleep 模式下工作
 - 支持硬件自动步进式地增加或减少占空比，可用于 LED RGB 彩色梯度发生器 
 
<!-- 列表上下空一行 -->
**ESP32-C3系列芯片包含如下列表型号：**

| 芯片型号 | 嵌入式 Flash | 环境温度(°C) | 封装(mm)|
| :------:| :------: | :------: | :------: |
| ESP32-C3 | -- | -40 ~ 105 |QFN32(5x5) |
| ESP32-C3FN4 | 4MB | -40 ~ 85 | QFN32(5x5) |
| ESP32-C3FH4 | 4MB | -40 ~ 105 | QFN32(5x5) |

<!-- 结尾空一行 -->

## 2. ESP32-C3应用电路设计 <!-- 使用二级标题 -->
<!-- 开头空一行 -->
 ESP32-C3 系列芯片的高度集成使得其外围电路设计较为简单。ESP32-C3 系列芯片的核心电路只由20个左右的电阻电容电感、1个无源晶振及 1个 SPI flash 组成。ESP32-C3 芯片的核心应用电路图如下图 1所示。
 
 **图 1：ESP32-C3芯片的核心应用电路图**
 
### 2.1 电源： 
  ESP32-C3系列芯片的管脚11和管脚17分别为RTC_IO 输入电源管脚和CPU_IO输入电源管脚，工作电压范围为3.0 V ~ 3.6 V。建议在电路中靠近数字电源管脚处分别添加0.1 μF电容。VDD_SPI 作为输出电源时，主要给外部SPI Flash供电，建议靠近该电源管脚处添加 1 μF 对地滤波电容。当使用 VDD_SPI 给嵌入式和外部 3.3 V flash 供电时，需要满足 flash 的工作电压要求，一般应保证 VDD3P3_CPU 在 3.0 V 及以上。
   
   ESP32-C3 系列芯片的管脚 2、管脚 3、管脚 31 和管脚 32 为模拟电源管脚，工作电压范围为 3.0 V ~ 3.6 V。该部分电源需要注意的是当 ESP32-C3 系列芯片工作在 TX 时，瞬间电流会加大，往往引起电源的轨道塌陷。所以在电路设计时建议在电源走线上增加一个 10 μF 电容，该电容可与 0.1 μF 电容搭配使用。另外，在靠近管脚2 和管脚 3 处还需添加 LC 滤波电路，用于抑制高频谐波，同时请注意该电感的额定电流最好在 500 mA 及以上。其余电源管脚请参考图 3 放置相应的去耦电容。
   
### 2.2 上电时序与复位： 
   ESP32-C3 系列芯片使用 3.3 V 作为统一的系统电源，所以上电时序上只需遵循:ESP32-C3 系列芯片的管脚7 CHIP _ EN 使能管脚上电要晚于系统电源 3.3 V 上电。
    为确保芯片上电时的供电正常，CHIP _ EN 管脚处需要增加 RC 延迟电路。RC 通常建议为 R=10kΩ ，C=1 μF，但具体数值仍需根据电源的上电时序和芯片的上电复位时序进行调整。
    CHIP _ EN也是芯片的复位管脚。当CHIP_ EN为低电平时，建议复位电平(V IL_nRST)范围为(-0.3~0.25 × VDD)V, (其中 VDD 为 I/O 的供电电源)。为防止外界干扰引起重启，CHIP__EN 引线需尽量短一些，且最好加上拉电阻和对地电容，该管脚不可浮空。
    
### 2.3 SPI Flash： 
   ESP32-C3系列芯片的外部SPI flash 可以最大支持到16 MB。如果使用ESP32-C3FH4/FN4芯片时，内部已经包含了4MB SPI Flash。SPI Flash使用VDD_SPI输出电源供电。可以给Flash提供3.3v或1.8v供电。
 
### 2.4 时钟源：
   ESP32-C3系列芯片固件目前仅支持40MHz主晶振。晶振外部匹配电容C1、C2具体值需要通过对系统测试后确定。请在XTAL_P时钟走线上放置一个串联元器件，以减小晶振谐波对射频的影响，初始可以使用24nH的电感，具体值可以通过射频测试后确认，选用的晶振自身精度需在 ±10 ppm。ESP32-C3 系列芯片内部已经集成了RC振荡器作为RTC时钟源，也支持使用外置32.768 kHz的时钟振荡器作为RTC时钟源。

### 2.5 射频：
  从ESP32-C3的射频端口LNA_IN到天线之间，设计时需添加π型匹配网络以便对天线进行匹配。建议π型匹配网络优先采用CLC结构。
 
### 2.6 Strapping 管脚：
 ESP32-C3系列芯片共有三个 Strapping管脚，分别为GPIO 2，GPIO 8，GPIO 9 。在芯片的系统复位过程中，Strapping 管脚对自己管脚上的电平采样并存储到锁存器中，并一直保持到芯片掉电或关闭。根据锁存器中存储的Strapping管脚状态，芯片在复位后会进入不同的模式状态，详细参考如下列表的模式（表1: Strapping 管脚）。复位放开后，Strapping 管脚和普通管脚功能相同。

   **表 1: Strapping 管脚 - 系统启动模式**
    
| 管脚 | 默认 | SPI启动模式 | 下载启动模式 |
| :------:| :------: | :------: | :------: |
| GPIO 2 | 无 | 1 | 1 |
| GPIO 8 | 无 | 无关项 | 1 |
| GPIO 9 | 内部弱上拉 | 1 | 0 |

   **Strapping 管脚 - 系统启动过程中，控制ROM Code打印**
  
   **eFuse 的 EFUSE _ UART _ PRINT_CONTROL 字段为** 
  
     0 时（默认值）：上电正常打印，不受 GPIO8 控制。
     1 时：若 GPIO8 为 0，上电正常打印;若 GPIO8 为 1，上电不打印。
     2 时：若 GPIO8 为 0，上电不打印;若 GPIO8 为 1，上电正常打印。
     3 时：上电不打印，不受 GPIO8 控制。

### 2.7 GPIO和PWM功能：
ESP32-C3系列共有22个GPIO 管脚，通过配置对应的寄存器，可以为这些管脚分配不同的功能。所有 GPIO 都可选择内部上拉/下拉，或设置为高阻。IO MUX 和 GPIO 交换矩阵用于将信号从外设传输至 GPIO 管脚。两者共同组成了芯片的 IO 控制。利用GPIO交换矩阵，可配置外设模块的输入信号来源于任何的IO管脚，并且外设模块的输出信号也可连接到任意IO管脚。

  LED PWM控制器可以生成6路独立的PWM数字波形输出，通过GPIO交换矩阵，可以配置到任意IO管脚使用。

<!-- 列表上下空一行 -->

<!-- 列表上下空一行 -->

## 3. 使用ESP32-C3构建智能照明系统 <!-- 使用二级标题 -->
<!-- 开头空一行 -->
  基于ESP32-C3芯片，乐鑫也设计标准的模组，在模组中除了ESP32-C3芯片外，已经包含了晶振、Flash、天线及射频电路和外围主要器件，是ESP32-C3的最小运行系统，并通过了SRRC,CE,FCC等主要安规认证，可以直接用于产品中。

### 3.1 模组选用<!-- 使用三级标题，因为这里也是和上一级标题相关内容 -->
<!-- 开头空一行 -->

基于ESP32-C3系列芯片的标准模组有如下型号，依照不同天线方式分为PCB天线模组和IPEX外接天线模组。根据尺寸及管脚方式不同还分为 WROOM系列和MINI系列。

**表 2 ：ESP32-C3系列模组列表**

| 模组型号 | 天线类型 | 工作温度(°C) | 产品尺寸(mm)| 规格书 |
| :------:| :------: | :------: | :------: | :------: |
| ESP32-C3-WROOM-02 | PCB天线 | -40 ~ 85/105 |QFN32(5x5) |[下载](https://www.espressif.com/sites/default/files/documentation/esp32-c3-wroom-02_datasheet_cn.pdf)|
| ESP32-C3-WROOM-02U | IPEX外接天线 | -40 ~ 85/105 | QFN32(5x5) |[下载](https://www.espressif.com/sites/default/files/documentation/esp32-c3-wroom-02_datasheet_cn.pdf)|
| ESP32-C3-MINI-1 | PCB天线 | -40 ~ 85/105 | QFN32(5x5) | [下载](https://www.espressif.com/sites/default/files/documentation/esp32-c3-mini-1_datasheet_cn.pdf)|
| ESP32-C3-MINI-1U | IPEX外接天线 | -40 ~ 85/105 | QFN32(5x5) | [下载](https://www.espressif.com/sites/default/files/documentation/esp32-c3-mini-1_datasheet_cn.pdf) |


### 3.2 应用原理框图及GPIO配置 <!-- 使用三级标题，因为这里也是和上一级标题相关内容 -->
<!-- 开头空一行 -->

ESP32-C3 的LED PWM 控制器可以生成6路独立的PWM信号，可以通过GPIO交换矩阵配置到任意GPIO上输出。在本设计中，使用其中的5路PWM输出，分别作为R（红色）G（绿色）B（蓝色）CW（冷白）WW（暖白）的LED控制信号。

在设计中我们选用ESP32-C3-WROOM-02 模组进行应用系统设计，如下是系统原理框图及各路PWM输出的GPIO配置表。

| 功能 | 选用的GPIO | 
| :------:| :------: | 
| R（红色） | GPIO 3 | 
| G（绿色） | GPIO 4 |
| B（蓝色） | GPIO 5 | 
| CW（冷白）| GPIO 7 |
| WW（暖白）| GPIO 10|


 **图 1-1 应用原理图**
 

### 3.3 固件烧录和调试接口 <!-- 使用三级标题，因为这里也是和上一级标题相关内容 -->
<!-- 开头空一行 -->

#### 3.3.1. 固件烧录接口

ESP32-C3芯片进入下载启动模式时，可以通过UART 0接口下载固件到ESP32-C3连接的SPI Flash中。
ESP32-C3 集成一个 USB 串口/JTAG 控制器，所以也可以通过USB接口下载固件到芯片连接的SPI Flash中。

#### 3.3.2 调试接口
 
  - **串口log打印：**ESP32-C3 ROM Code 及 IDF SDK默认通过 UART 0输出log信息，也可以使用芯片集成的USB串口，通过USB接口查看log输出信息。
  
  - **JTAG调试：**ESP32-C3的 MTMS/GPIO 4 ，MTDI/GPIO 5， MTCK/GPIO 6 ， MTDO/GPIO 7 为JTAG调试端口。也可以使用芯片集成的 USB JTAG 控制器直接用于调试。
    

### 3.4 射频设计要求 <!-- 使用三级标题，因为这里也是和上一级标题相关内容 -->
<!-- 开头空一行 -->

产品采用模组进行设计时，则需注意考虑模组在底板的布局，应尽可能地减小底板对模组PCB天线 性能的影响。建议将模组尽可能地靠近底板板边放置，条件允许的情况下，PCB 天线区域最好是可以延伸出底板板框外，并使天线的馈点距离板边最近。




**图 2: ESP32­-C3 系列模组在底板上的位置示意图(模组天线馈点在右侧)**





**图 3: ESP32­-C3系列模组在底板上的位置示意图(模组天线馈点在左侧)**




 **说明:**
 
    在图 2 中，ESP32-C3系列模组(馈点在右)在底板上的位置建议如下: 
    位置 3、4:强烈推荐;
    位置 1、2、5:不推荐。

    在图 3中，ESP32-C3系列模组(馈点在左)在底板上的位置建议如下:
    位置 1、5:强烈推荐; 
    位置 2、3、4:不推荐。

 如上述方法受限而无法实行，请确保模块不被任何金属的外壳包裹，模块 PCB 天线区域及外扩 15 mm 区域请 净空(严禁铺铜、走线、摆放元件)。该净空区域越大越好，如图 4所示。另外，建议将 PCB 天线下方区域的底板切割掉，以尽可能地减少底板板材对 PCB 天线的影响。涉及整机设计时，请注意考虑外壳对天线的影响。
 
 
 **图 4: ESP32­C3 系列模组天线区域净空示意图**
 
 
### 3.5 供电电源设计要求 <!-- 使用三级标题，因为这里也是和上一级标题相关内容 -->
<!-- 开头空一行 -->

 模组使用单一管脚供电，只需外接 1个 3.3V、可提供500 mA 及以上电流输出的电源即可。电源纹波可极大地影响射频的 TX 性能，一般情况下，发送 MCS7@11n的包时，电源纹波峰峰值必须 <80 mV。发送 11m@11b 时，电源纹波峰峰值必须 <120 mV。

 
## 4. 参考资料
<!-- 开头空一行 -->

- [ESP32-C3规格书](https://www.espressif.com/sites/default/files/documentation/esp32-c3_datasheet_cn.pdf) ，
- [ESP32-C3技术参考手册](https://www.espressif.com/sites/default/files/documentation/esp32-c3_technical_reference_manual_cn.pdf)，
- [ESP32-C3硬件设计指南](https://www.espressif.com/sites/default/files/documentation/esp32-c3_hardware_design_guidelines_cn.pdf) 

<!-- 文档结尾空一行 -->
