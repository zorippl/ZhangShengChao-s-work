# 第 4 章 基于 ESP32-C3 智能照明设备的工程搭建

本章将首先介绍 ESP32-C3 的官方软件开发环境 ESP-IDF，以及在不同操作系统上的搭建该开发环境的方法。之后将以一个典型工程为例，介绍 ESP-IDF 代码工程结构、编译系统、以及相关开发工具的使用方法。最后将演示示例代码的实际编译运行过程，详细解读不同环节的输出信息。

## 4.1 ESP-IDF 概述

ESP-IDF (Espressif IoT Development Framework) 是乐鑫科技官方提供的一站式物联网开发框架，它以 C/C++ 为主要开发语言，支持 Linux、macOS、Windows 等主流操作系统。本书提供的示例程序均是基于 ESP-IDF 搭建，它具有以下特性：

1. 包含 ESP32、ESP2-S2、ESP32-C3 等 SoC 系统级驱动，主要包括外设底层 LL、HAL 库、RTOS 支持和上层驱动软件等；
2. 包含物联网开发必要的基础组件，主要包括 HTTP，MQTT 等多种网络协议栈，支持动态调频的低功耗管理框架，支持 Flash 加密和安全启动的加密库等；
3. 提供了如图 ?-? 开发和量产过程中最常用的构建、烧录、调试和测量功能和工具，例如基于 CMake 构建系统、基于 GCC 的交叉工具链、基于 OpenOCD 的 JTAG 调试工具等。 

> 注：ESP-IDF 代码基于 Apache-2.0 宽松开源协议，用户可以不受限制的进行个人或商业软件开发，且不需要开放修改后的源代码；TODO: 是否需要单独小结介绍该协议权利和限制？

![](./_static/what-you-need.png)

### 4.1.1 ESP-IDF 版本介绍

ESP-IDF 代码在 Github 上开放，目前有 ESP-IDF v3 和 v4 两个主要版本，每个主版本跟随其后有不同的子版本号，例如 v4.2, v4.3 等，乐鑫还为每个发布的子版本提供 30 个月的 bug 修复、安全修复支持，因此一般还有针对不同子版本修订版本，例如 v4.3.1，v4.2.2 等。 

主版本的迭代往往伴随着框架结构的调整和编译系统更新，例如 v3 到 v4 的主要变化是构建系统从 make 逐渐迁移到 CMake，子版本一般意味着新增功能或新增芯片支持。如表 ？-？ 展示了 ESP-IDF 不同版本对乐鑫芯片的支持状态，其中 ![alt text](_static/lable_preview.svg) 为提供预览版本支持，预览版本可能缺少关键的功能或文档，![alt text](_static/lable_supported.svg) 表示提供正式版本支持。

| Chip     |          v3.3          |          v4.0          |          v4.1          |          v4.2          |          v4.3          |          v4.4          |
| :------- | :--------------------: | :--------------------: | :--------------------: | :--------------------: | :--------------------: | :--------------------: |
| ESP32    | ![alt text](_static/lable_supported.svg) | ![alt text](_static/lable_supported.svg) | ![alt text](_static/lable_supported.svg) | ![alt text](_static/lable_supported.svg) | ![alt text](_static/lable_supported.svg) | ![alt text](_static/lable_supported.svg) |
| ESP32-S2 |                        |                        |                        | ![alt text](_static/lable_supported.svg) | ![alt text](_static/lable_supported.svg) | ![alt text](_static/lable_supported.svg) |
| ESP32-C3 |                        |                        |                        |                        | ![alt text](_static/lable_supported.svg) | ![alt text](_static/lable_supported.svg) |
| ESP32-S3 |                        |                        |                        |                        |  ![alt text](_static/lable_preview.svg)  | ![alt text](_static/lable_supported.svg) |
| ESP32-H2 |                        |                        |                        |                        |                        |  ![alt text](_static/lable_preview.svg)  |

读者还需要注意稳定版本和 Github 分支的区别和联系，如上带有 `vA.B` 或 `vA.B.C` 标签的版本均被称为稳定版本，稳定版本已通过乐鑫完整内部测试，都有独立的发布文档，同一个版本号下的代码和工具链后期不会再有变更。而 Github 分支例如 `release/v4.3` 分支几乎每天都会有新的代码的被提交，因此，同在该分支下的两份代码可能是不同的，需要开发者及时更新。

### 4.1.2 选择一个合适的版本

由于 ESP-IDF 在 `v4.3` 版本开始对 ESP32-C3 正式支持，且本章撰写时 v4.4 版本还未正式发布，因此本书选择 v4.3 版本进行讲解。当您读到本章节时，可能已经有更新的版本发布，对于版本的选择我们有以下建议：

1. 对于入门开发者，推荐选择稳定版本 v4.3 及其修订版本，与本书示例版本保持一致。
2. 如果有量产需求，推荐使用最新稳定版本（如您阅读本书时最新的稳定版本可能已经是 v4.4），以便获得最及时的技术支持。
3. 如需尝试新芯片或者预研产品新功能，请使用 `master` 分支，最新版本包含所有最新特性，但存在已知或未知的 Bug。
4. 如需使用稳定版本没有的新特性，又想降低使用 `master` 分支的风险，请使用对应的发布分支，例如 `release/v4.4` 分支（ESP-IDF Github 会先创建 release/v4.4 分支，等完成全部功能开发和测试，会基于该分支的某一历史节点发布稳定版本 `v4.4`）